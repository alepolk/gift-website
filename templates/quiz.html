<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–±–æ—Ä –ø–æ–¥–∞—Ä–∫–∞ ‚Äî –ß—Ç–æ –ø–æ–¥–∞—Ä–∏—Ç—å</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="quiz-page">
    <!-- –®–∞–ø–∫–∞ -->
    <header class="quiz-header">
        <div class="container">
            <a href="/" class="back-btn">‚Üê –ù–∞–∑–∞–¥</a>
            <span class="progress-text" id="progressText">–í–æ–ø—Ä–æ—Å 1 –∏–∑ 10</span>
        </div>
    </header>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 10%"></div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="quiz-content">
        <div class="container">
            <!-- –û–±—ã—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã -->
            <div id="questionContainer">
                <div class="question-icon" id="questionIcon">üí∞</div>
                <h2 class="question-text" id="questionText">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <div class="options" id="optionsContainer"></div>
            </div>

            <!-- –ò–Ω—Ç–µ—Ä–µ—Å—ã (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä) -->
            <div id="interestsContainer" style="display: none;">
                <div class="question-icon">üéØ</div>
                <h2 class="question-text">–ö–∞–∫–∏–µ —É–≤–ª–µ—á–µ–Ω–∏—è –µ—Å—Ç—å —É –ø–æ–ª—É—á–∞—Ç–µ–ª—è?</h2>
                <p style="color: #64748b; margin-bottom: 24px; font-size: 14px;">–í—ã–±–µ—Ä–∏ –≤—Å–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ</p>
                <div class="interests-grid" id="interestsGrid"></div>
                <div class="interests-actions">
                    <button class="btn-secondary" id="skipInterests">–ù–µ –∑–Ω–∞—é —É–≤–ª–µ—á–µ–Ω–∏–π</button>
                    <button class="btn-submit" id="submitInterests">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥–∞—Ä–∫–∏</button>
                </div>
            </div>

            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
            <div id="loadingContainer" style="display: none;">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>–ü–æ–¥–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–µ –ø–æ–¥–∞—Ä–∫–∏...</p>
                </div>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
            <div id="resultsContainer" style="display: none;"></div>
        </div>
    </main>

    <script>
        // –î–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å–æ–≤
        const questions = {{ questions | tojson }};
        
        let currentQuestion = 0;
        let answers = [];
        let selectedInterests = [];
        let allGifts = [];
        let displayedGifts = 0;
        let gender = 'gender_male';
        let age = 'age_26_35';
        let sessionId = null;
        let ratedGifts = {}; // –•—Ä–∞–Ω–∏—Ç –æ—Ü–µ–Ω–∫–∏: {gift_id: rating}

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            showQuestion(0);
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤–æ–ø—Ä–æ—Å
        function showQuestion(index) {
            if (index >= questions.length) {
                showInterests();
                return;
            }

            const q = questions[index];
            currentQuestion = index;

            document.getElementById('progressText').textContent = `–í–æ–ø—Ä–æ—Å ${index + 1} –∏–∑ 10`;
            document.getElementById('progressFill').style.width = `${(index + 1) * 10}%`;
            document.getElementById('questionIcon').textContent = q.icon;
            document.getElementById('questionText').textContent = q.text;

            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';

            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option';
                btn.textContent = opt.text;
                btn.onclick = () => selectOption(q, opt.value);
                container.appendChild(btn);
            });
        }

        // –í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞
        function selectOption(question, value) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª –∏ –≤–æ–∑—Ä–∞—Å—Ç –¥–ª—è –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
            if (question.tag === 'gender') {
                gender = value;
            }
            if (question.tag === 'age') {
                age = value;
            }

            answers.push({
                tag: question.tag,
                value: value
            });

            // –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
            showQuestion(currentQuestion + 1);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—ã
        async function showInterests() {
            document.getElementById('questionContainer').style.display = 'none';
            document.getElementById('interestsContainer').style.display = 'block';
            document.getElementById('progressText').textContent = '–í–æ–ø—Ä–æ—Å 10 –∏–∑ 10';
            document.getElementById('progressFill').style.width = '100%';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ç–µ—Ä–µ—Å—ã –ø–æ –ø–æ–ª—É –∏ –≤–æ–∑—Ä–∞—Å—Ç—É
            const response = await fetch(`/api/interests?gender=${gender}&age=${age}`);
            const interests = await response.json();

            const grid = document.getElementById('interestsGrid');
            grid.innerHTML = '';

            interests.forEach(int => {
                const btn = document.createElement('button');
                btn.className = 'interest-option';
                btn.textContent = int.text;
                btn.dataset.value = int.value;
                btn.onclick = () => toggleInterest(btn, int.value);
                grid.appendChild(btn);
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å
        function toggleInterest(btn, value) {
            btn.classList.toggle('selected');
            
            if (selectedInterests.includes(value)) {
                selectedInterests = selectedInterests.filter(i => i !== value);
            } else {
                selectedInterests.push(value);
            }
        }

        // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—ã
        document.getElementById('skipInterests').onclick = () => {
            selectedInterests = [];
            getResults();
        };

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        document.getElementById('submitInterests').onclick = () => {
            getResults();
        };

        // –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        async function getResults() {
            document.getElementById('interestsContainer').style.display = 'none';
            document.getElementById('loadingContainer').style.display = 'block';

            const response = await fetch('/api/results', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    answers: answers,
                    interests: selectedInterests
                })
            });

            const data = await response.json();
            allGifts = data.gifts;
            sessionId = data.session_id;
            displayedGifts = 0;

            setTimeout(() => {
                document.getElementById('loadingContainer').style.display = 'none';
                showResults();
            }, 1000);
        }

        // –û—Ü–µ–Ω–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫
        async function rateGift(giftId, giftName, rating) {
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            ratedGifts[giftId] = rating;
            updateRatingButtons(giftId, rating);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            await fetch('/api/rate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    gift_id: giftId,
                    gift_name: giftName,
                    rating: rating
                })
            });
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –æ—Ü–µ–Ω–∫–∏
        function updateRatingButtons(giftId, rating) {
            const card = document.querySelector(`[data-gift-id="${giftId}"]`);
            if (!card) return;

            const likeBtn = card.querySelector('.btn-like');
            const dislikeBtn = card.querySelector('.btn-dislike');

            likeBtn.classList.remove('active');
            dislikeBtn.classList.remove('active');

            if (rating === 1) {
                likeBtn.classList.add('active');
            } else if (rating === -1) {
                dislikeBtn.classList.add('active');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        function showResults() {
            const container = document.getElementById('resultsContainer');
            container.style.display = 'block';

            if (allGifts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 0;">
                        <p style="font-size: 18px; margin-bottom: 20px;">üòî –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ –Ω–∞—à–ª–æ—Å—å –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥–∞—Ä–∫–æ–≤</p>
                        <a href="/quiz" class="btn-restart">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</a>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="results-header" style="background: transparent; border: none; padding: 0 0 20px;">
                    <h1 class="results-title">üéÅ –ü–æ–¥–æ–±—Ä–∞–ª–∏ ${allGifts.length} –ø–æ–¥–∞—Ä–∫–æ–≤</h1>
                    <p class="results-subtitle">–û—Ü–µ–Ω–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã ‚Äî —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç —É–ª—É—á—à–∏—Ç—å –ø–æ–¥–±–æ—Ä</p>
                </div>
                <div id="giftsContainer"></div>
            `;

            container.innerHTML = html;
            loadMoreGifts();
        }

        // –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ–¥–∞—Ä–∫–∞
        function createGiftCard(gift) {
            const currentRating = ratedGifts[gift.id] || 0;
            const likeActive = currentRating === 1 ? 'active' : '';
            const dislikeActive = currentRating === -1 ? 'active' : '';

            return `
                <div class="gift-card" data-gift-id="${gift.id}">
                    <div class="gift-card-header">
                        <span class="gift-name">${gift.name}</span>
                        <span class="gift-price">${gift.price}</span>
                    </div>
                    ${gift.description ? `<p class="gift-description">${gift.description}</p>` : ''}
                    <div class="gift-rating">
                        <button class="btn-rate btn-like ${likeActive}" onclick="rateGift(${gift.id}, '${gift.name.replace(/'/g, "\\'")}', 1)">
                            üëç –ù—Ä–∞–≤–∏—Ç—Å—è
                        </button>
                        <button class="btn-rate btn-dislike ${dislikeActive}" onclick="rateGift(${gift.id}, '${gift.name.replace(/'/g, "\\'")}', -1)">
                            üëé –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç
                        </button>
                    </div>
                </div>
            `;
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë –ø–æ–¥–∞—Ä–∫–∏
        function loadMoreGifts() {
            const container = document.getElementById('giftsContainer');
            const giftsToShow = allGifts.slice(displayedGifts, displayedGifts + 5);
            
            giftsToShow.forEach(gift => {
                container.insertAdjacentHTML('beforeend', createGiftCard(gift));
            });

            displayedGifts += giftsToShow.length;

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É
            const oldBtn = document.getElementById('loadMoreBtn');
            if (oldBtn) oldBtn.remove();

            const oldRestart = document.getElementById('restartSection');
            if (oldRestart) oldRestart.remove();

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë" –µ—Å–ª–∏ –µ—Å—Ç—å –µ—â—ë –ø–æ–¥–∞—Ä–∫–∏
            if (displayedGifts < allGifts.length) {
                const loadMore = document.createElement('div');
                loadMore.className = 'load-more';
                loadMore.id = 'loadMoreBtn';
                loadMore.innerHTML = `
                    <button class="btn-load-more" onclick="loadMoreGifts()">
                        –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë ${Math.min(5, allGifts.length - displayedGifts)} –∏–∑ ${allGifts.length - displayedGifts}
                    </button>
                `;
                container.after(loadMore);
            }

            // –ö–Ω–æ–ø–∫–∞ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
            const restart = document.createElement('div');
            restart.className = 'restart-section';
            restart.id = 'restartSection';
            restart.innerHTML = `<a href="/quiz" class="btn-restart">üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>`;
            document.getElementById('resultsContainer').appendChild(restart);
        }
    </script>
</body>
</html>